<!-- Enhanced Papers Management Section with Language Support -->
<div id="papers" class="admin-section">
    <h2 class="mb-4">Manage Exam Papers</h2>
    
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Add Exam Paper</h5>
        </div>
        <div class="card-body">
            <form id="addPaperForm">
                <div class="row">
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Grade</label>
                            <select class="form-select" id="paperGrade" required>
                                <!-- Will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <select class="form-select" id="paperSubject" required>
                                <!-- Will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Language</label>
                            <select class="form-select" id="paperLanguage" required>
                                <option value="english">English</option>
                                <option value="sinhala">සිංහල (Sinhala)</option>
                                <option value="tamil">தமிழ் (Tamil)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Paper Type</label>
                            <select class="form-select" id="paperType" required>
                                <option value="">Select Type</option>
                                <option value="term">Term Paper</option>
                                <option value="chapter">Chapter Paper</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="paperCategory" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">School Name</label>
                            <input type="text" class="form-control" id="schoolName" placeholder="e.g., Royal College, Ananda College">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Paper File (PDF)</label>
                            <input type="file" class="form-control" id="paperFile" accept=".pdf" required>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-upload me-2"></i>Upload Paper
                </button>
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Existing Papers</h5>
            <div class="filter-controls">
                <select class="form-select form-select-sm" id="filterGrade" style="width: auto; display: inline-block;">
                    <option value="">All Grades</option>
                </select>
                <select class="form-select form-select-sm ms-2" id="filterSubject" style="width: auto; display: inline-block;">
                    <option value="">All Subjects</option>
                </select>
                <select class="form-select form-select-sm ms-2" id="filterLanguage" style="width: auto; display: inline-block;">
                    <option value="">All Languages</option>
                    <option value="english">English</option>
                    <option value="sinhala">සිංහල</option>
                    <option value="tamil">தமிழ்</option>
                </select>
                <select class="form-select form-select-sm ms-2" id="filterType" style="width: auto; display: inline-block;">
                    <option value="">All Types</option>
                    <option value="term">Term Papers</option>
                    <option value="chapter">Chapter Papers</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="papersList">
                <!-- Will be populated -->
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Notes Management Section with Language Support -->
<div id="notes" class="admin-section">
    <h2 class="mb-4">Manage Short Notes</h2>
    
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Add Short Notes</h5>
        </div>
        <div class="card-body">
            <form id="addNotesForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Grade</label>
                            <select class="form-select" id="notesGrade" required>
                                <!-- Will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <select class="form-select" id="notesSubject" required>
                                <!-- Will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Language</label>
                            <select class="form-select" id="notesLanguage" required>
                                <option value="english">English</option>
                                <option value="sinhala">සිංහල (Sinhala)</option>
                                <option value="tamil">தமிழ் (Tamil)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Chapter</label>
                            <select class="form-select" id="notesChapter" required>
                                <option value="">Select Chapter</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Notes File (PDF)</label>
                    <input type="file" class="form-control" id="notesFile" accept=".pdf" required>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-upload me-2"></i>Upload Notes
                </button>
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Existing Notes</h5>
        </div>
        <div class="card-body">
            <div id="notesList">
                <!-- Will be populated -->
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Videos Management Section with Language Support -->
<div id="videos" class="admin-section">
    <h2 class="mb-4">Manage Video Lessons</h2>
    
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Add Video Lesson</h5>
        </div>
        <div class="card-body">
            <form id="addVideoForm">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Grade</label>
                            <select class="form-select" id="videoGrade" required>
                                <!-- Will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <select class="form-select" id="videoSubject" required>
                                <!-- Will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Language</label>
                            <select class="form-select" id="videoLanguage" required>
                                <option value="english">English</option>
                                <option value="sinhala">සිංහල (Sinhala)</option>
                                <option value="tamil">தமிழ් (Tamil)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Video Title</label>
                    <input type="text" class="form-control" id="videoTitle" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">YouTube URL</label>
                    <input type="url" class="form-control" id="videoUrl" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Chapter/Topic</label>
                    <input type="text" class="form-control" id="videoChapter">
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus me-2"></i>Add Video
                </button>
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Existing Videos</h5>
        </div>
        <div class="card-body">
            <div id="videosList">
                <!-- Will be populated -->
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced Admin Functions with Language Support

// Papers Management Functions
async function handlePaperSubmission(e) {
    e.preventDefault();
    
    const formData = {
        gradeId: document.getElementById('paperGrade').value,
        subjectId: document.getElementById('paperSubject').value,
        paperType: document.getElementById('paperType').value,
        paperCategory: document.getElementById('paperCategory').value,
        language: document.getElementById('paperLanguage').value,
        schoolName: document.getElementById('schoolName').value,
        file: document.getElementById('paperFile').files[0]
    };
    
    // Validation
    if (!formData.gradeId || !formData.subjectId || !formData.paperType || !formData.paperCategory || !formData.language || !formData.file) {
        showAlert('Please fill in all required fields and select a file.', 'warning');
        return;
    }
    
    if (formData.file.type !== 'application/pdf') {
        showAlert('Please select a PDF file.', 'warning');
        return;
    }
    
    // Show loading state
    const btn = document.querySelector('#addPaperForm button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
    btn.disabled = true;
    
    try {
        const path = `${formData.gradeId}/${formData.subjectId}/papers`;
        const fileData = await window.dataManager.simulateFileUpload(formData.file, path);
        
        // Add paper using enhanced method with language
        window.dataManager.addPaper(
            formData.gradeId,
            formData.subjectId,
            formData.paperType,
            formData.paperCategory,
            fileData,
            formData.schoolName,
            formData.language
        );
        
        showAlert('Paper uploaded successfully!', 'success');
        document.getElementById('addPaperForm').reset();
        loadPapersList();
        
    } catch (error) {
        showAlert('Upload failed. Please try again.', 'danger');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Notes Management Functions
async function handleNotesSubmission(e) {
    e.preventDefault();
    
    const formData = {
        gradeId: document.getElementById('notesGrade').value,
        subjectId: document.getElementById('notesSubject').value,
        language: document.getElementById('notesLanguage').value,
        chapter: document.getElementById('notesChapter').value,
        file: document.getElementById('notesFile').files[0]
    };
    
    // Validation
    if (!formData.gradeId || !formData.subjectId || !formData.language || !formData.chapter || !formData.file) {
        showAlert('Please fill in all required fields and select a file.', 'warning');
        return;
    }
    
    if (formData.file.type !== 'application/pdf') {
        showAlert('Please select a PDF file.', 'warning');
        return;
    }
    
    // Show loading state
    const btn = document.querySelector('#addNotesForm button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
    btn.disabled = true;
    
    try {
        const path = `${formData.gradeId}/${formData.subjectId}/notes`;
        const fileData = await window.dataManager.simulateFileUpload(formData.file, path);
        
        // Add notes using enhanced method with language
        window.dataManager.addNotes(
            formData.gradeId,
            formData.subjectId,
            formData.chapter,
            fileData,
            formData.language
        );
        
        showAlert('Notes uploaded successfully!', 'success');
        document.getElementById('addNotesForm').reset();
        loadNotesList();
        
    } catch (error) {
        showAlert('Upload failed. Please try again.', 'danger');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Video Management Functions
function addVideoWithLanguage() {
    const gradeId = document.getElementById('videoGrade').value;
    const subjectId = document.getElementById('videoSubject').value;
    const language = document.getElementById('videoLanguage').value;
    const title = document.getElementById('videoTitle').value;
    const url = document.getElementById('videoUrl').value;
    const chapter = document.getElementById('videoChapter').value;
    
    if (!gradeId || !subjectId || !language || !title || !url) {
        showAlert('Please fill in all required fields.', 'warning');
        return;
    }
    
    // Validate YouTube URL
    if (!isValidYouTubeUrl(url)) {
        showAlert('Please enter a valid YouTube URL.', 'warning');
        return;
    }
    
    window.dataManager.addVideo(gradeId, subjectId, {
        title: title,
        url: url,
        chapter: chapter,
        language: language
    });
    
    showAlert('Video lesson added successfully!', 'success');
    document.getElementById('addVideoForm').reset();
    loadVideosList();
}

// Setup Functions
function setupNotesManagement() {
    // Populate chapter dropdown
    for (let i = 1; i <= 20; i++) {
        const option = document.createElement('option');
        option.value = `chapter${i}`;
        option.textContent = `Chapter ${i}`;
        document.getElementById('notesChapter').appendChild(option);
    }
    
    // Setup grade change listener
    document.getElementById('notesGrade').addEventListener('change', function() {
        populateSubjectDropdown('notesSubject', this.value);
    });
    
    // Setup form submission
    document.getElementById('addNotesForm').addEventListener('submit', handleNotesSubmission);
}

function setupVideosManagement() {
    // Setup grade change listener
    document.getElementById('videoGrade').addEventListener('change', function() {
        populateSubjectDropdown('videoSubject', this.value);
    });
    
    // Setup form submission
    document.getElementById('addVideoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addVideoWithLanguage();
    });
}

// Enhanced filter function for papers
function filterPapersWithLanguage() {
    const filterGrade = document.getElementById('filterGrade')?.value || '';
    const filterSubject = document.getElementById('filterSubject')?.value || '';
    const filterLanguage = document.getElementById('filterLanguage')?.value || '';
    const filterType = document.getElementById('filterType')?.value || '';
    
    const gradeGroups = document.querySelectorAll('.paper-group');
    
    gradeGroups.forEach(group => {
        const gradeId = group.getAttribute('data-grade');
        let gradeVisible = !filterGrade || gradeId === filterGrade;
        
        if (!gradeVisible) {
            group.style.display = 'none';
            return;
        }
        
        const subjectSections = group.querySelectorAll('.paper-category-section');
        let hasVisibleSubjects = false;
        
        subjectSections.forEach(section => {
            const subjectId = section.getAttribute('data-subject');
            let subjectVisible = !filterSubject || subjectId === filterSubject;
            
            if (!subjectVisible) {
                section.style.display = 'none';
                return;
            }
            
            const paperItems = section.querySelectorAll('.paper-item-enhanced');
            let hasVisiblePapers = false;
            
            paperItems.forEach(item => {
                const paperLanguage = item.getAttribute('data-language') || 'english';
                const paperType = item.closest('[data-paper-type]')?.getAttribute('data-paper-type') || '';
                
                const languageMatch = !filterLanguage || paperLanguage === filterLanguage;
                const typeMatch = !filterType || paperType === filterType;
                
                if (languageMatch && typeMatch) {
                    item.style.display = 'flex';
                    hasVisiblePapers = true;
                } else {
                    item.style.display = 'none';
                }
            });
            
            if (hasVisiblePapers) {
                section.style.display = 'block';
                hasVisibleSubjects = true;
            } else {
                section.style.display = 'none';
            }
        });
        
        group.style.display = hasVisibleSubjects ? 'block' : 'none';
    });
}

// Load Notes List
function loadNotesList() {
    const grades = window.dataManager.getGrades();
    const container = document.getElementById('notesList');
    
    container.innerHTML = '';
    
    Object.keys(grades).forEach(gradeId => {
        const grade = grades[gradeId];
        const subjects = window.dataManager.getSubjectsForGrade(gradeId);
        
        Object.keys(subjects).forEach(subjectId => {
            const subject = subjects[subjectId];
            const resources = window.dataManager.getResources(gradeId, subjectId);
            
            if (resources.notes && Object.keys(resources.notes).length > 0) {
                Object.keys(resources.notes).forEach(noteKey => {
                    const note = resources.notes[noteKey];
                    const item = document.createElement('div');
                    item.className = 'resource-item';
                    item.innerHTML = `
                        <div class="resource-info">
                            <h6>${subject.name} - ${note.chapter || noteKey} (${grade.display})</h6>
                            <div class="resource-meta">
                                <span class="badge bg-primary">${getLanguageDisplayName(note.language || 'english')}</span>
                                <small class="text-muted ms-2">${note.filename} • ${formatFileSize(note.size)}</small>
                            </div>
                        </div>
                        <div class="resource-actions">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${gradeId}', '${subjectId}', '${noteKey}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
        });
    });
    
    if (container.children.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No notes uploaded yet.</div>';
    }
}

// Load Videos List
function loadVideosList() {
    const grades = window.dataManager.getGrades();
    const container = document.getElementById('videosList');
    
    container.innerHTML = '';
    
    Object.keys(grades).forEach(gradeId => {
        const grade = grades[gradeId];
        const subjects = window.dataManager.getSubjectsForGrade(gradeId);
        
        Object.keys(subjects).forEach(subjectId => {
            const subject = subjects[subjectId];
            const videos = window.dataManager.getVideos(gradeId, subjectId);
            
            if (videos && videos.length > 0) {
                videos.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'resource-item';
                    item.innerHTML = `
                        <div class="resource-info">
                            <h6>${video.title} (${grade.display} - ${subject.name})</h6>
                            <div class="resource-meta">
                                <span class="badge bg-primary">${getLanguageDisplayName(video.language || 'english')}</span>
                                ${video.chapter ? `<span class="badge bg-info ms-1">${video.chapter}</span>` : ''}
                                <small class="text-muted ms-2">Added: ${new Date(video.addedDate).toLocaleDateString()}</small>
                            </div>
                        </div>
                        <div class="resource-actions">
                            <a href="${video.url}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="bi bi-youtube"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteVideo('${gradeId}', '${subjectId}', '${video.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
        });
    });
    
    if (container.children.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No videos uploaded yet.</div>';
    }
}

// Enhanced Paper Item Creation with Language
function createPaperItemWithLanguage(gradeId, subjectId, paperType, categoryKey, paper) {
    const item = document.createElement('div');
    item.className = 'paper-item-enhanced';
    item.setAttribute('data-language', paper.language || 'english');
    
    const uploadDate = new Date(paper.uploadDate).toLocaleDateString();
    const fileSize = formatFileSize(paper.size);
    
    item.innerHTML = `
        <div class="paper-info">
            <h6>${paper.filename}</h6>
            <div class="paper-meta">
                <span class="badge bg-primary">${getLanguageDisplayName(paper.language || 'english')}</span>
                ${paper.school ? `<span class="badge bg-info ms-1">${paper.school}</span>` : ''}
                <small class="text-muted d-block mt-1">
                    Uploaded: ${uploadDate} • Size: ${fileSize}
                </small>
            </div>
        </div>
        <div class="paper-actions">
            <a href="${paper.path}" class="btn btn-sm btn-outline-primary" download>
                <i class="bi bi-download"></i>
            </a>
            <button class="btn btn-sm btn-outline-danger" onclick="deletePaperItem('${gradeId}', '${subjectId}', '${paperType}', '${categoryKey}', '${paper.id}')">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    
    return item;
}

// Delete Functions
function deleteNote(gradeId, subjectId, noteKey) {
    if (confirm('Are you sure you want to delete this note?')) {
        window.dataManager.deleteNote(gradeId, subjectId, noteKey);
        showAlert('Note deleted successfully!', 'success');
        loadNotesList();
    }
}

function deleteVideo(gradeId, subjectId, videoId) {
    if (confirm('Are you sure you want to delete this video?')) {
        window.dataManager.deleteVideo(gradeId, subjectId, videoId);
        showAlert('Video deleted successfully!', 'success');
        loadVideosList();
    }
}

// Utility Functions
function getLanguageDisplayName(language) {
    const names = {
        'sinhala': 'සිංහල',
        'tamil': 'தமிழ்',
        'english': 'English'
    };
    return names[language] || language;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function isValidYouTubeUrl(url) {
    const regex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/;
    return regex.test(url);
}

// Initialize enhanced management when sections are loaded
document.addEventListener('DOMContentLoaded', function() {
    // Setup enhanced papers management
    if (document.getElementById('addPaperForm')) {
        document.getElementById('addPaperForm').addEventListener('submit', handlePaperSubmission);
        
        // Add language filter listener
        const filterLanguage = document.getElementById('filterLanguage');
        if (filterLanguage) {
            filterLanguage.addEventListener('change', filterPapersWithLanguage);
        }
    }
    
    // Setup notes management
    if (document.getElementById('addNotesForm')) {
        setupNotesManagement();
    }
    
    // Setup videos management
    if (document.getElementById('addVideoForm')) {
        setupVideosManagement();
    }
});
</script>

<style>
/* Enhanced Admin Styles for Language Support */
.resource-meta {
    margin-top: 0.5rem;
}

.resource-meta .badge {
    font-size: 0.7rem;
    margin-right: 0.25rem;
}

.paper-meta .badge {
    font-size: 0.7rem;
    margin-right: 0.25rem;
}

.language-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 4px;
}

.language-indicator.sinhala {
    background-color: #FF5722;
}

.language-indicator.tamil {
    background-color: #9C27B0;
}

.language-indicator.english {
    background-color: #2196F3;
}

.available-languages {
    display: flex;
    align-items: center;
    gap: 2px;
}

.subject-overview-card-link {
    text-decoration: none;
    color: inherit;
}

.subject-overview-card-link:hover {
    text-decoration: none;
    color: inherit;
}

/* Filter controls styling */
.filter-controls .form-select {
    min-width: 120px;
}

/* Enhanced paper item styling */
.paper-item-enhanced[data-language="sinhala"] {
    border-left: 3px solid #FF5722;
}

.paper-item-enhanced[data-language="tamil"] {
    border-left: 3px solid #9C27B0;
}

.paper-item-enhanced[data-language="english"] {
    border-left: 3px solid #2196F3;
}

/* Resource item enhancements */
.resource-item {
    border-left: 3px solid #e9ecef;
    transition: border-color 0.3s ease;
}

.resource-item:hover {
    border-left-color: var(--admin-primary);
}
</style>